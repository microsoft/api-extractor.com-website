"use strict";(self.webpackChunkapi_extractor_com=self.webpackChunkapi_extractor_com||[]).push([[7304],{158:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>h});var a=n(6393);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),p=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},u=function(e){var t=p(e.components);return a.createElement(s.Provider,{value:t},e.children)},m="mdxType",c={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,s=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),m=p(n),d=r,h=m["".concat(s,".").concat(d)]||m[d]||c[d]||o;return n?a.createElement(h,i(i({ref:t},u),{},{components:n})):a.createElement(h,i({ref:t},u))}));function h(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=d;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[m]="string"==typeof e?e:r,i[1]=l;for(var p=2;p<o;p++)i[p]=n[p];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},1922:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>u,contentTitle:()=>s,default:()=>h,frontMatter:()=>l,metadata:()=>p,toc:()=>m});var a=n(9122),r=n(2501),o=(n(6393),n(158)),i=["components"],l={title:"Configuring a .d.ts rollup"},s=void 0,p={unversionedId:"pages/setup/configure_rollup",id:"pages/setup/configure_rollup",title:"Configuring a .d.ts rollup",description:'_This article continues the tutorial from the "Invoking API Extractor" page.',source:"@site/docs/pages/setup/configure_rollup.md",sourceDirName:"pages/setup",slug:"/pages/setup/configure_rollup",permalink:"/pages/setup/configure_rollup",draft:!1,editUrl:"https://github.com/microsoft/rushstack-websites/tree/main/websites/api-extractor.com/docs/pages/setup/configure_rollup.md",tags:[],version:"current",frontMatter:{title:"Configuring a .d.ts rollup"},sidebar:"docsSidebar",previous:{title:"Configuring an API report",permalink:"/pages/setup/configure_api_report"},next:{title:"Generating API docs",permalink:"/pages/setup/generating_docs"}},u={},m=[{value:"Simple case",id:"simple-case",level:2},{value:"An important limitation",id:"an-important-limitation",level:2},{value:"Trimming based on release tags",id:"trimming-based-on-release-tags",level:2}],c={toc:m},d="wrapper";function h(e){var t=e.components,n=(0,r.Z)(e,i);return(0,o.kt)(d,(0,a.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("p",null,(0,o.kt)("em",{parentName:"p"},'This article continues the tutorial from the "',(0,o.kt)("a",{parentName:"em",href:"/pages/setup/invoking"},"Invoking API Extractor"),"\" page.\nIt's recommended to start there.")),(0,o.kt)("h2",{id:"simple-case"},"Simple case"),(0,o.kt)("p",null,"To enable .d.ts rollup generation, you simply need to set ",(0,o.kt)("inlineCode",{parentName:"p"},"dtsRollup.enabled")," to true in your ",(0,o.kt)("strong",{parentName:"p"},"api-extractor.json"),"\nconfig file."),(0,o.kt)("p",null,"By default, the rollup file will be written to ",(0,o.kt)("inlineCode",{parentName:"p"},'"<projectFolder>/dist/<unscopedPackageName>.d.ts"'),",\nbut you can change this using the ",(0,o.kt)("inlineCode",{parentName:"p"},"dtsRollup.untrimmedFilePath")," setting."),(0,o.kt)("p",null,"Recall from our earlier example that the original ",(0,o.kt)("strong",{parentName:"p"},"package.json")," file looked like this:"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"awesome-widgets/package.json")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'{\n  "name": "awesome-widgets",\n  "version": "1.0.0",\n  "main": "./lib/index.js",\n  "typings": "./lib/index.d.ts"\n}\n')),(0,o.kt)("p",null,"To actually use the rollup, we need to change the ",(0,o.kt)("inlineCode",{parentName:"p"},'"typings"')," field to point to the rollup file, like this:"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"awesome-widgets/package.json")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'{\n  "name": "awesome-widgets",\n  "version": "1.0.0",\n  "main": "./lib/index.js",\n  "typings": "./dist/awesome-widgets.d.ts"\n}\n')),(0,o.kt)("p",null,"This directs the TypeScript compiler to look for its typings in the new location.\nIf you use Webpack to bundle your JavaScript, you might also change ",(0,o.kt)("inlineCode",{parentName:"p"},'"main"')," to point to your\n",(0,o.kt)("inlineCode",{parentName:"p"},'"./dist/awesome-widgets.js"')," bundle, and then you could probably add your entire ",(0,o.kt)("strong",{parentName:"p"},"lib")," folder\nto the ",(0,o.kt)("strong",{parentName:"p"},".npmignore")," file and make your package a lot smaller."),(0,o.kt)("h2",{id:"an-important-limitation"},"An important limitation"),(0,o.kt)("p",null,"The .d.ts rollup feature currently assumes that your package has a single entry point (the ",(0,o.kt)("inlineCode",{parentName:"p"},"mainEntryPointFilePath"),"\nsetting). This isn't always the case. Some projects rely on path-based imports, like this:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},"import { Button } from 'awesome-widgets/lib/Button';\n")),(0,o.kt)("p",null,"This import statement is fishing around in the ",(0,o.kt)("strong",{parentName:"p"},"awesome-widgets")," folder tree to find a specific file.\nIn general this is incompatible with a rollup, since any exported declarations will now have two copies:\none in the ",(0,o.kt)("strong",{parentName:"p"},"lib")," folder, and one in the rollup file. The TypeScript compiler generally does not consider\nduplicated declarations to be interchangeable, and it can lead to some very confusing error messages."),(0,o.kt)("p",null,"From an API design standpoint, path-based imports have a downside that the folder layout becomes part of your API\ncontract: For example, if we want to reorganize ",(0,o.kt)("strong",{parentName:"p"},"lib/Button")," into a ",(0,o.kt)("strong",{parentName:"p"},"lib/controls/Button")," folder, we now\nneed to worry that this is a breaking change for any consumer who's doing path-based imports. The TSDoc project\nhas considered this problem, and its ",(0,o.kt)("strong",{parentName:"p"},"tsdoc-metadata.json")," file is planned to eventually declare the officially\nsupported entry points for a project. Its declaration reference notation already allows import paths."),(0,o.kt)("p",null,"But today, API Extractor assumes your project has a single entry point. (The API Extractor developers do not\nconsider path-based imports to be a best practice, so we have eliminated them from all of the hundreds of TypeScript\npackages that we work on. Thus, this enhancement is not a top priority for us. If someone from the community wants\nto work on it, though, we'd certainly help with that effort.)"),(0,o.kt)("p",null,"Although multiple entry points pose a problem for .d.ts rollups, fortunately you CAN still use the API report file\nand documentation features: You would simply create a dummy source file such as ",(0,o.kt)("strong",{parentName:"p"},"src/api-extractor.ts")," that\nreexports all your various entry points, and then specify that as your ",(0,o.kt)("inlineCode",{parentName:"p"},"mainEntryPointFilePath"),". This allows\nAPI Extractor to analyze all your declarations as if they came from a single entry point."),(0,o.kt)("h2",{id:"trimming-based-on-release-tags"},"Trimming based on release tags"),(0,o.kt)("p",null,'The .d.ts rollup feature also supports "trimming", i.e. removing unwanted members according to their\n',(0,o.kt)("a",{parentName:"p",href:"/pages/tsdoc/doc_comment_syntax#release-tags"},"release tag")," (",(0,o.kt)("inlineCode",{parentName:"p"},"@alpha"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"@beta"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"@public"),", or\n",(0,o.kt)("inlineCode",{parentName:"p"},"@internal"),'). Keep in mind that in API Extractor\'s terminology, "beta" does not refer to the readiness\nof an entire release branch. Instead, we\'re using "beta" to describe the support level for\n',(0,o.kt)("em",{parentName:"p"},"individual API members"),". Thus, the trimmed version and untrimmed version will typically be compiled from\nthe exact same source files and the exact same Git branch."),(0,o.kt)("p",null,"To enable trimming, add these settings to your ",(0,o.kt)("strong",{parentName:"p"},"api-extractor.json")," file:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},(0,o.kt)("inlineCode",{parentName:"p"},"dtsRollup.betaTrimmedFilePath"),' - Specifies the output path for a .d.ts rollup file to be generated with\ntrimming for a "beta" release. This file will include only declarations that are marked as ',(0,o.kt)("inlineCode",{parentName:"p"},"@public")," or ",(0,o.kt)("inlineCode",{parentName:"p"},"@beta"),".")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},(0,o.kt)("inlineCode",{parentName:"p"},"dtsRollup.publicTrimmedFilePath"),' - Specifies the output path for a .d.ts rollup file to be generated with\ntrimming for a "public" release. This file will include only declarations that are marked as ',(0,o.kt)("inlineCode",{parentName:"p"},"@public"),"."))),(0,o.kt)("p",null,"The build mechanics are left up to you, but typically we recommend for the ",(0,o.kt)("inlineCode",{parentName:"p"},'"typings"')," field in your\n",(0,o.kt)("strong",{parentName:"p"},"package.json")," to continue to point to the untrimmed rollup file. If you work on a collection of related packages,\nthis allows your packages to continue to have full access to the untrimmed declarations during the build.\nFor example, an ",(0,o.kt)("inlineCode",{parentName:"p"},"@internal")," function in one package may make calls to an ",(0,o.kt)("inlineCode",{parentName:"p"},"@internal")," function in your other package.\nThe trimmed files are wired up after the build, prior to ",(0,o.kt)("inlineCode",{parentName:"p"},"npm publish"),"."),(0,o.kt)("p",null,"Continuing the example project from earlier, we could modify our ",(0,o.kt)("strong",{parentName:"p"},"api-extractor.json")," file to contain\na section like this:"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"awesome-widgets/config/api-extractor.json")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'{\n  . . .\n  "dtsRollup": {\n    "enabled": true,\n    "untrimmedFilePath": "<projectFolder>/dist/<unscopedPackageName>.d.ts",\n    "betaTrimmedFilePath": "<projectFolder>/dist/<unscopedPackageName>-beta.d.ts",,\n    "publicTrimmedFilePath": "<projectFolder>/dist/<unscopedPackageName>-public.d.ts"\n  },\n}\n')),(0,o.kt)("p",null,"Imagine that we will build and publish three types of releases from the exact same source code:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"internal release:")," Version ",(0,o.kt)("inlineCode",{parentName:"li"},"1.0.0-dev.0")," gets published to our private NPM registry at our company"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"beta release:")," Version ",(0,o.kt)("inlineCode",{parentName:"li"},"1.0.0-plusbeta")," gets published to the npmjs.com registry for consumers who want\nto experiment with preview APIs"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"public release:")," Version ",(0,o.kt)("inlineCode",{parentName:"li"},"1.0.0")," also gets published to the npmjs.com registry for consumers who\nare writing production code")),(0,o.kt)("p",null,"To publish an internal release, we simply run ",(0,o.kt)("inlineCode",{parentName:"p"},"npm publish")," in the project folder."),(0,o.kt)("p",null,"To publish a beta release, we would first update the ",(0,o.kt)("inlineCode",{parentName:"p"},'"typings"')," field in ",(0,o.kt)("strong",{parentName:"p"},"package.json")," to point to ",(0,o.kt)("strong",{parentName:"p"},"awesome-widgets-beta.d.ts"),". (Alternatively, we could overwrite the ",(0,o.kt)("strong",{parentName:"p"},"dist/awesome-widgets.d.ts")," with\nthat file.) Then we run ",(0,o.kt)("inlineCode",{parentName:"p"},"npm publish"),"."),(0,o.kt)("p",null,"To publish a public release, we would first update the ",(0,o.kt)("inlineCode",{parentName:"p"},'"typings"')," field in ",(0,o.kt)("strong",{parentName:"p"},"package.json")," to point to ",(0,o.kt)("strong",{parentName:"p"},"awesome-widgets-public.d.ts"),". (Alternatively, we could overwrite the ",(0,o.kt)("strong",{parentName:"p"},"dist/awesome-widgets.d.ts")," with\nthat file.) Then we run ",(0,o.kt)("inlineCode",{parentName:"p"},"npm publish"),"."),(0,o.kt)("p",null,"Many other approaches are possible as well. Your build scripts can use these files however you like.\nThe approach described here the advantage that consumers can easily switch between different release types\nbased on their version selection, and we've found it works well when you need to publish a set of\nclosely interrelated NPM packages."))}h.isMDXComponent=!0}}]);